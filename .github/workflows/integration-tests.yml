name: Run Integration Tests

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'The environment to run the tests in (qa|prod)'
        default: 'qa'
  workflow_dispatch:
    inputs:
      environment:
        required: true
        type: string
        description: 'The environment to run the tests in (qa|prod)'
        default: 'qa'

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python 3.10
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Download csv version of the database
      run: wget -O sources.csv https://bit.ly/catalogs-csv

    - name: Get full path of sources.csv
      id: getpath
      run: echo "PATH=$(realpath sources.csv)" >> $GITHUB_ENV

    - name: Install dependencies
      working-directory: integration-tests
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Integration Tests
      env:
        REFRESH_TOKEN: ${{ if eq(inputs.environment, 'qa') }}${{ secrets.QA_API_TEST_REFRESH_TOKEN }}${{ else }}${{ secrets.PROD_API_TEST_REFRESH_TOKEN }}${{ endif }}
        FILE_PATH: ${{ env.PATH }}
        API_URL: ${{ if eq(inputs.environment, 'qa') }}https://api-qa.mobilitydatabase.org${{ else }}https://api.mobilitydatabase.org${{ endif }}
      run: |
        ./scripts/integration-tests.sh -u $API_URL -t $REFRESH_TOKEN -f $FILE_PATH
    
    - name: Upload Test Logs
      uses: actions/upload-artifact@v2
      with:
        name: integration-tests-results
        working-directory: integration-tests
        path: |
          src/integration_tests_log.html
          src/datasets_validation.csv
          
          
          


name: Web App - Build Deploy
on:
  workflow_call:
  pull_request:
    branches: [ main ]
    paths:
      - 'web-app/**'
env:
  NODE_VERSION: '18'
on:
  

jobs:
  build:
    name: 'Build'
    # permissions: write-all
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      id: gcloud_auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_MOBILITY_FEEDS_SA_KEY }}

    - name: Google Cloud Setup
      uses: google-github-actions/setup-gcloud@v1

    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: {{ inputs.NODE_VERSION }}

    - name: Install dependencies
      run: yarn install    

    - name: Build React app
      run: yarn build

    # - name: Test React app
    #   run: yarn test

    - name: Install Firebase CLI
      run: npm install -g firebase-tools

    - name: Authenticate to Google Cloud
      id: gcloud_auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_MOBILITY_FEEDS_SA_KEY }}

    - name: Authenticate with Firebase
      run: |
        echo "$FIREBASE_TOKEN" | firebase login:ci --no-localhost

    - name: Deploy to Firebase Hosting
      run: firebase deploy --only hosting